#!/bin/sh
set -euf

PID=$(pgrep -u "$USER" gnome-session)
if [ -z "$PID" ]; then
  exit 0
fi
export DBUS_SESSION_BUS_ADDRESS=$(grep -z DBUS_SESSION_BUS_ADDRESS "/proc/$PID/environ"|cut -d= -f2-)
bgdir="$HOME/Pictures/wallpapers"
history="${bgdir}/.history"

touch "$history"
selection=$(find -L "$bgdir" -type f -name "*.jpg" -o -name "*.png" | shuf -n1)
tail -n999 "$history" | sponge "$history"
echo "$selection" | tee -a "$history"
gsettings set org.gnome.desktop.background picture-uri "file://$selection"
